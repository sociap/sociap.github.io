<!DOCTYPE html>
<html>

<head>
  <title>Fila de Atendimento</title>
</head>

<body>
  <h1>Fila de Atendimento</h1>
  <div id="peer-id"></div>
  <video id="local-video" autoplay></video>
  <video id="remote-video" autoplay></video>
  <button id="fechar-conversa" onclick="fecharConversa()" >Fechar Conversa</button>

  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.3.2/dist/peerjs.min.js"></script>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    userid = urlParams.get('id');
    if (userid == undefined) {
      throw new Error("usuario nao identificado!");
    }
    console.log('fora');
    console.log(userid);

    function fecharConversa(){
      console.log('fechar conversa');
      console.log(userid);
      console.log("https://chat.sociap.com.br/chat/close?id=" + userid);
      if (remoteVideo) {
          remoteVideo.parentNode.removeChild(videoElement);
      }

      remoteVideo.srcObject = '';
    }

    const txtPeerId = document.getElementById('peer-id');

    const peer = new Peer();
    peer.on('open', id => {
      console.log("https://chat.sociap.com.br/atendente/add?id=" + userid + "&peerid=" + id);
      fetch("https://chat.sociap.com.br/atendente/add?id=" + userid + "&peerid=" + id)
        .then(res => { return res.json() })
        .then(response => {
          txtPeerId.textContent = id
          console.log(response);
        });
    });

    const localVideo = document.getElementById('local-video');
    const remoteVideo = document.getElementById('remote-video');

    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
      localVideo.srcObject = stream;
        // Answer incoming calls
        peer.on('call', call => {
          console.log("aqui!");
          call.answer(stream);
          call.on('stream', remoteStream => {
            console.log("aqui2!");
            remoteVideo.srcObject = remoteStream;
          });
        });
    });
  </script>
</body>

</html>