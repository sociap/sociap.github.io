<!DOCTYPE html>
<html>

<head>
  <title>Fila de Atendimento</title>
</head>

<body>
  <h1>Fila de Atendimento</h1>
  <video id="local-video" autoplay></video>
  <video id="remote-video" autoplay></video>

  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.3.2/dist/peerjs.min.js"></script>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    userid = urlParams.get('id');
    if (userid == undefined) {
      throw new Error("usuario nao identificado!");
    }
    console.log('fora');
    console.log(userid);

    const peer = new Peer();

    const localVideo = document.getElementById('local-video');
    const remoteVideo = document.getElementById('remote-video');

    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
    localVideo.srcObject = stream;
        // Answer incoming calls
        peer.on('call', call => {
          call.answer(stream);
          call.on('stream', remoteStream => {
            remoteVideo.srcObject = remoteStream;
          });
        });
    });

    peer.on('open', id => {
      console.log('dentro');
      console.log("http://chat.sociap.com.br/atendente/add?id=" + userid + "&peerid=" + id);
      fetch("http://chat.sociap.com.br/atendente/add?id=" + userid + "&peerid=" + id)
        .then(res => { return res.json() })
        .then(response => {
          console.log(response);
        });
    });

//    var getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
//    peer.on('call', function (call) {
//      getUserMedia({ video: true, audio: true }, function (stream) {
//        call.answer(stream); // Answer the call with an A/V stream.
//        call.on('stream', function (remoteStream) {
//          remoteVideo.srcObject = remoteStream;
//        });
//      }, function (err) {
//        console.log('Failed to get local stream', err);
//      });
//    });
  </script>
</body>

</html>