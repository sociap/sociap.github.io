<!DOCTYPE html>
<html>

<head>
    <title>Fila de Atendimento</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.3.2/dist/peerjs.min.js"></script>
</head>

<body>
    <h1>Fila de Atendimento</h1>
    <div id="atendente-id"></div>
    <video id="remote-video" autoplay></video>
    PL2

    <script>
        const peer = new Peer();

        const remoteVideo = document.getElementById('remote-video');
        const strAtendenteId = document.getElementById('atendente-id');
        const atendenteId = ""
        const aguardandoAtendimento = true

        while (aguardandoAtendimento) {
            setTimeout(function timer() {
                fetch("https://chat.sociap.com.br/atendente/get")
                .then(res => { return res.json() })
                .then(response => {
                    console.log('Aqui2!!');
                    console.log(response);
                    strAtendenteId.textContent = response.peer;
                    atendenteId = response.peer;
                    if (atendenteId  != "") {
                        navigator.mediaDevices.getUserMedia({ video: false, audio: true }).then(stream => {
                            console.log("audio");
                            console.log(atendenteId);
                            var call = peer.call(atendenteId, stream);
                            call.on('stream', function (remoteStream) {
                                remoteVideo.srcObject = remoteStream;
                            });
                            aguardandoAtendimento = false;
                        });
                        console.log("hello world");
                    }
                })
            }, 1000);
        }
    </script>
</body>

</html>